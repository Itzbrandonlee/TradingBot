<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yahoo Finance App</title>
</head>
<body>
  <h1>Yahoo Finance Data</h1>
  <input type="date" id="userDate"/>
  <button onclick="fetchHistorical('FNGU')">Download Historical FNGU Data</button>
  <button onclick="fetchHistorical('FNGD')">Download Historical FNGD Data</button>
  <button onclick="backtest()">Backtest</button>
  <pre id="output"></pre>

  <script>
    let jsonData = null;
    let transactions = [];
    //This function fetches the data and saves it into a JSON
    async function fetchHistorical(dataset) {
      try {
      //  const today = new Date();
      //  let currentDate = today.getFullYear() + "-" + (today.getMonth() + 1) + "-" + (today.getDate() - 1);
        const userDate = document.getElementById("userDate").value;
        console.log(userDate);
        const response = await fetch(`/api/historical?symbol=${dataset}&currentDate=${userDate}`);
        const data = await response.json();
        const quotes = data.quotes;

        jsonData = quotes;

        console.log(jsonData);
        const blob = new Blob([JSON.stringify(jsonData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'historical_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      //  document.getElementById('output').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error('Error fetching historical data:', error);
      }
    }

    //Backtest the algo
    async function backtest() {
      try {
        const closingPrices = jsonData.map(quote => quote.close);
        const shortTimeFrame = 10;
        const longTimeFrame = 50;
        let shortSMA = calcSMA(closingPrices, shortTimeFrame, longTimeFrame);
        let longSMA = calcSMA(closingPrices, longTimeFrame, longTimeFrame);

        let beginningYearIndex = 0;
        const userInfo = {
            balance: 100000,
            numStock: 0,
        }

        let shortBelow = (shortSMA < longSMA) ? true : false;
        for(let i = 50; i < closingPrices.length; i++) {
            shortSMA = updateSMA(closingPrices, shortSMA, i, shortTimeFrame);
            longSMA = updateSMA(closingPrices, longSMA, i, longTimeFrame);

            if(shortSMA > longSMA && shortBelow) {
                buyStock(jsonData, userInfo, i, transactions);
                shortBelow = false;
            }
            else if(shortSMA < longSMA && !shortBelow && userInfo.numStock > 0) {
                sellStock(jsonData, userInfo, i, transactions);
                shortBelow = true;
            }
        }

        for(let i = 0; i < transactions.length; i++) {
            console.log(transactions[i]);
        }

        console.log("BALANCE: " + userInfo.balance);
        console.log("AMOUNT INVESTED: " + (userInfo.numStock * closingPrices[closingPrices.length - 1]));
        console.log("TOTAL RETURN: " + (((userInfo.numStock * closingPrices[closingPrices.length - 1] + userInfo.balance) - 100000) / 1000).toFixed(2) + "%");

        printStats(userInfo, transactions);
      } catch (error) {
        console.error('Error fetching sma data:', error);
      }
    }

    //Calculates the starting SMA
    function calcSMA(closingPrices, timeFrame, startingIndex) {
        let sum = 0.00;
        for(let i = startingIndex - timeFrame; i < startingIndex; i++) {
            sum += closingPrices[i];
        }

        return (sum / timeFrame);
    }

    //This is a testing function to judge the accuracy of updateSMA
    function testSMA(closingPrices, sma, index, smaSize) {
      let sum = 0.00;
      for(let i = (index-smaSize); i < index; i++) {
        sum += closingPrices[i];
      }
      let avg = sum / smaSize;
      console.log("SMA: " + sma);
      console.log("TESTED SMA: " + avg);
    }

    function updateSMA(closingPrices, sma, index, smaSize) {
        sma = (smaSize * sma - closingPrices[index - smaSize] + closingPrices[index]) / smaSize;//((closingPrices[index] - closingPrices[index-smaSize]) / smaSize);
        console.log("SIZE: " + smaSize + " index: " + index);
        return sma;
    }

    function buyStock(jsonData, userInfo, index, transactions) {
        const amountToInvest = userInfo.balance * 0.6;
        if(amountToInvest > jsonData[index].close) {
            const numSharesToBuy = Math.floor(amountToInvest / jsonData[index].close);
            const singleTransaction = {isBuy: true, date: jsonData[index].date, numShares: numSharesToBuy, price: jsonData[index].close};
            transactions.push(singleTransaction);
            userInfo.balance -= (numSharesToBuy * jsonData[index].close);
            userInfo.numStock += numSharesToBuy;
        }
    }

    function sellStock(jsonData, userInfo, index, transactions) {
        const numSharesToSell = Math.min(userInfo.numStock, Math.floor(userInfo.numStock * 0.6));
        const singleTransaction = {isBuy: false, date: jsonData[index].date, numShares: numSharesToSell, price: jsonData[index].close};
        transactions.push(singleTransaction);
        userInfo.balance += (numSharesToSell * jsonData[index].close);
        userInfo.numStock -= numSharesToSell;
    }
    function printStats(userInfo, transactions) {
        let date = null;
        let singleGainLoss = 0;
        let totalGainLoss = 0;
        let currentNumStock = 0;
        let currentBalance = 100000;
        let outputText = "";
        for(let i = 0; i < transactions.length; i++) {
            date = transactions[i].date.split('T')[0];
            if(transactions[i].isBuy) {
                currentNumStock += transactions[i].numShares;
                currentBalance -= transactions[i].numShares * transactions[i].price;
                outputText += `${date} BUY: ${transactions[i].numShares} shares @ $${transactions[i].price}\n`;
            }
            else {
                currentNumStock -= transactions[i].numShares;
                currentBalance += transactions[i].numShares * transactions[i].price;
                singleGainLoss = transactions[i].numShares * (transactions[i].price - (100000 - userInfo.balance) / userInfo.numStock);//singleGainLoss = (currentNumStock * transactions[i].price + currentBalance) - 100000;
                totalGainLoss += singleGainLoss;
                outputText += `${date} SELL: ${transactions[i].numShares} shares @ $${transactions[i].price} GAIN/LOSS: $${singleGainLoss.toFixed(2)} TOTAL GAIN/LOSS: $${totalGainLoss.toFixed(2)}\n`;

            }

          //  outputText += (date + " " + "SINGLE GAIN/LOSS: $" + singleGainLoss.toFixed(2) + " TOTAL GAIN/LOSS: $" + totalGainLoss.toFixed(2) + "\n");
        }
        document.getElementById('output').textContent = outputText;
    }
  </script>
</body>
</html>
